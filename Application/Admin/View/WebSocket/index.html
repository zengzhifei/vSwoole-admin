<include file="Public/head"/>
<include file="Public/top"/>
<div class="clearfix">
    <div class="page-container">
        <include file="Public/left"/>

        <div class="page-content-wrapper">
            <div class="page-content">
                <!-- BEGIN SAMPLE PORTLET CONFIGURATION MODAL FORM-->
                <div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="portlet-config"
                     class="modal fade">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button aria-hidden="true" data-dismiss="modal" class="close" type="button"></button>
                                <h4 class="modal-title">Modal title</h4>
                            </div>
                            <div class="modal-body">
                                Widget settings form goes here
                            </div>
                            <div class="modal-footer">
                                <button class="btn blue" type="button">Save changes</button>
                                <button data-dismiss="modal" class="btn default" type="button">Close</button>
                            </div>
                        </div>
                        <!-- /.modal-content -->
                    </div>
                    <!-- /.modal-dialog -->
                </div>
                <!-- /.modal -->
                <!-- END SAMPLE PORTLET CONFIGURATION MODAL FORM-->
                <!-- BEGIN PAGE HEADER-->
                <!-- BEGIN PAGE HEAD -->
                <div class="page-head">
                    <!-- BEGIN PAGE TITLE -->
                    <!-- END PAGE TITLE -->
                    <!-- BEGIN PAGE TOOLBAR -->
                    <!--<div class="page-toolbar">
                         BEGIN THEME PANEL
                        <div class="btn-group btn-theme-panel">
                            <a data-toggle="dropdown" class="btn dropdown-toggle" href="javascript:;">
                            <i class="icon-settings"></i>
                            </a>
                            <div class="dropdown-menu theme-panel pull-right dropdown-custom hold-on-click">
                                <div class="row">
                                    <div class="col-md-4 col-sm-4 col-xs-12">
                                        <h3>THEME</h3>
                                        <ul class="theme-colors">
                                            <li data-theme="default" class="theme-color theme-color-default active">
                                                <span class="theme-color-view"></span>
                                                <span class="theme-color-name">Dark Header</span>
                                            </li>
                                            <li data-theme="light" class="theme-color theme-color-light">
                                                <span class="theme-color-view"></span>
                                                <span class="theme-color-name">Light Header</span>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="col-md-8 col-sm-8 col-xs-12 seperator">
                                        <h3>LAYOUT</h3>
                                        <ul class="theme-settings">
                                            <li>
                                                 Theme Style
                                                <select class="layout-style-option form-control input-small input-sm">
                                                    <option selected="selected" value="square">Square corners</option>
                                                    <option value="rounded">Rounded corners</option>
                                                </select>
                                            </li>
                                            <li>
                                                 Layout
                                                <select class="layout-option form-control input-small input-sm">
                                                    <option selected="selected" value="fluid">Fluid</option>
                                                    <option value="boxed">Boxed</option>
                                                </select>
                                            </li>
                                            <li>
                                                 Header
                                                <select class="page-header-option form-control input-small input-sm">
                                                    <option selected="selected" value="fixed">Fixed</option>
                                                    <option value="default">Default</option>
                                                </select>
                                            </li>
                                            <li>
                                                 Top Dropdowns
                                                <select class="page-header-top-dropdown-style-option form-control input-small input-sm">
                                                    <option value="light">Light</option>
                                                    <option selected="selected" value="dark">Dark</option>
                                                </select>
                                            </li>
                                            <li>
                                                 Sidebar Mode
                                                <select class="sidebar-option form-control input-small input-sm">
                                                    <option value="fixed">Fixed</option>
                                                    <option selected="selected" value="default">Default</option>
                                                </select>
                                            </li>
                                            <li>
                                                 Sidebar Menu
                                                <select class="sidebar-menu-option form-control input-small input-sm">
                                                    <option selected="selected" value="accordion">Accordion</option>
                                                    <option value="hover">Hover</option>
                                                </select>
                                            </li>
                                            <li>
                                                 Sidebar Position
                                                <select class="sidebar-pos-option form-control input-small input-sm">
                                                    <option selected="selected" value="left">Left</option>
                                                    <option value="right">Right</option>
                                                </select>
                                            </li>
                                            <li>
                                                 Footer
                                                <select class="page-footer-option form-control input-small input-sm">
                                                    <option value="fixed">Fixed</option>
                                                    <option selected="selected" value="default">Default</option>
                                                </select>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                         END THEME PANEL
                    </div> -->
                    <!-- END PAGE TOOLBAR -->
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <!-- BEGIN EXAMPLE TABLE PORTLET-->
                        <div class="portlet box blue">
                            <div class="portlet-title">
                                <div class="caption">
                                    <i class="fa fa-edit"></i>服务器管理
                                </div>
                            </div>
                            <style>
                                .table-bordered th {
                                    text-align: center
                                }
                            </style>
                            <div class="portlet-body">
                                <button style="margin-bottom:5px;" class="btn blue" type="button"
                                        id="server-reload-all">全部重载
                                </button>
                                <button style="margin-bottom:5px;" class="btn blue" type="button" id="server-close-all">
                                    全部关闭
                                </button>
                                <button style="margin-bottom:5px;" class="btn blue" type="button" id="server-clear-all">
                                    清除异常
                                </button>
                                <table class="table table-striped table-hover table-bordered">
                                    <thead>
                                    <tr>
                                        <th width="100px;">序号</th>
                                        <th>IP</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                    </thead>
                                    <tbody class="server_ips">
                                    <if condition="$server_list">
                                        <foreach name="server_list" key="k" item="v">
                                            <tr>
                                                <td>{$k + 1}</td>
                                                <td class="server_ip">{$v['server_ip']}</td>
                                                <td class="server_online">{$v['server_status'] == 1 ? '正常' : '异常'}</td>
                                                <td>
                                                    <if condition="$v['server_status'] == 1">
                                                        <a><a class="glyphicon glyphicon-refresh server-reload"
                                                              title="重载"></a></a>
                                                        <a><a class="glyphicon glyphicon-off server-close"
                                                              title="关闭"></a></a>
                                                        <else/>
                                                        <a><a style="pointer-events: none"
                                                              class="glyphicon glyphicon-refresh server-reload"
                                                              title="重载"></a></a>
                                                        <a><a style="pointer-events: none"
                                                              class="glyphicon glyphicon-off server-close"
                                                              title="关闭"></a></a>
                                                    </if>
                                                </td>
                                            </tr>
                                        </foreach>
                                        <else/>
                                        <tr>
                                            <td colspan="24" class="text-center"> aOh! 没有启动WebSocket的服务器!</td>
                                        </tr>
                                    </if>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- END EXAMPLE TABLE PORTLET-->
                    </div>
                </div>
                <!-- END PAGE CONTENT-->
            </div>
        </div>
    </div>
</div>
<script>
    $(function () {
        function clearServers() {
            $.ajax({
                url: "{:U('WebSocket/clearServers')}",
                type: 'GET',
                dataType: 'json',
                success: function (res) {
                    console.log(res);
                    if (res.status === 1) {
                        Interact.success_report('清除成功',function () {
                            location.reload();
                        });
                    } else {
                        Interact.error_report('清除失败');
                    }
                },
                error: function (e) {
                    console.log(e.statusText);
                }
            })
        }

        function reloadServer(server_ip) {
            $.ajax({
                url: "{:U('WebSocket/reloadServer')}",
                type: 'GET',
                data: {server_ip: server_ip},
                dataType: 'json',
                success: function (res) {
                    console.log(res);
                    if (res.status === 1) {
                        Interact.success_report('服务重载成功');
                    } else {
                        Interact.error_report('服务重载失败');
                    }
                },
                error: function (e) {
                    console.log(e.statusText);
                }
            })
        }

        function shutdownServer(server_ip) {
            $.ajax({
                url: "{:U('WebSocket/shutdownServer')}",
                type: 'GET',
                data: {server_ip: server_ip},
                dataType: 'json',
                success: function (res) {
                    console.log(res);
                    if (res.status === 1) {
                        Interact.success_report('服务关闭成功',function () {
                            location.reload();
                        });
                    } else {
                        Interact.error_report('服务关闭失败');
                    }
                },
                error: function (e) {
                    console.log(e.statusText);
                }
            })
        }

        $("#server-reload-all").on('click', function () {
            reloadServer(null);
        });
        $("#server-clear-all").on('click', function () {
            clearServers();
        });
        $("#server-close-all").on('click', function () {
            Interact.warning_report('确认关闭所有服务?', function () {
                shutdownServer(null);
            });
        });
        $("body").on('click', ".server-reload", function () {
            let server_ip = $(this).parents('tr').find('.server_ip').text();
            reloadServer(server_ip);
        });
        $("body").on('click', ".server-close", function () {
            let server_ip = $(this).parents('tr').find('.server_ip').text();
            shutdownServer(server_ip);
        });
    })
</script>

<include file="Public/footer"/>
