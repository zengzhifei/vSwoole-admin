<include file="Public/head" />
<include file="Public/top" />
<div class="clearfix">
    <div class="page-container">
    <include file="Public/left" />
        <div class="page-content-wrapper">
	        <div class="page-content">
	            <!-- BEGIN SAMPLE PORTLET CONFIGURATION MODAL FORM-->
	            <div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="portlet-config" class="modal fade">
	                <div class="modal-dialog">
	                    <div class="modal-content">
	                        <div class="modal-header">
	                            <button aria-hidden="true" data-dismiss="modal" class="close" type="button"></button>
	                            <h4 class="modal-title">Modal title</h4>
	                        </div>
	                        <div class="modal-body">
	                             Widget settings form goes here
	                        </div>
	                        <div class="modal-footer">
	                            <button class="btn blue" type="button">Save changes</button>
	                            <button data-dismiss="modal" class="btn default" type="button">Close</button>
	                        </div>
	                    </div>
	                    <!-- /.modal-content -->
	                </div>
	                <!-- /.modal-dialog -->
	            </div>
	            <!-- /.modal -->
	            <!-- END SAMPLE PORTLET CONFIGURATION MODAL FORM-->
	            <!-- BEGIN PAGE HEADER-->
	            <!-- BEGIN PAGE HEAD -->
	            <div class="page-head">
	                <!-- BEGIN PAGE TITLE -->
	                <!-- END PAGE TITLE -->
	            </div>
	            <!-- END PAGE HEAD -->
	            <!-- BEGIN PAGE BREADCRUMB -->
	            <!-- END PAGE BREADCRUMB -->
	            <!-- END PAGE HEADER-->
	            <!-- BEGIN PAGE CONTENT-->
	            
	            <div class="row">
	                <div class="col-md-12">
	                    <!-- BEGIN EXAMPLE TABLE PORTLET-->
	                    <div class="portlet box blue">
	                        <div class="portlet-title">
	                            <div class="caption">
	                                 <i class="fa fa-edit"></i>榜单管理
	                            </div>
	                        </div>
	                        <div class="portlet-body">
	                    	<ul class="nav nav-tabs ">
	                    			<li <if condition="$type eq 6">class="active"</if>>
                                        <a  href="{:U('Player/trueList',array('type'=>6,'stage_id'=>$stage_id))}" aria-expanded="ture">真实榜单</a>
                                    </li>
                                    <li <if condition="$type eq 2">class="active"</if>>
                                        <a  href="{:U('Player/showList',array('type'=>2,'stage_id'=>$stage_id))}" aria-expanded="ture">虚拟榜单</a>
                                    </li>
                                    
                                </ul>
	                        	<table class="table table-striped table-hover table-bordered">
	                                <thead>
	                                    <tr>
	                                    	<th>排名</th>
	                                        <th>编号</th>
	                                        <th>名称</th>
	                                        <th>答对题数</th>
	                                        <th>答题用时</th>
	                                       <!--  <th>VIP</th> -->
	                                    </tr>
	                                </thead>
	                                <tbody>
							<notempty name="_list">
								<volist name="_list" id="vo"  key="k">
									<tr>
										<td><span <if condition="$k elt 6">style="color:red;font-weight: bold"</if>>{$k}</span></td>
										<td>{$vo.number}</td>
										<td>{$vo.name}</td>
										<td>{$vo.right_num}</td>
										<td>{$vo.duration}</td>
										<!-- <td><if condition="$vo.is_vip eq 1"><span style="color:red">是</span><else/>否</if></td> -->
									</tr>
								</volist>
								<else/>
								<td colspan="9" class="text-center" style="color:red;font-weight: bold"> 本轮答题-虚拟榜单暂未开启! </td>
								</notempty>
	                                </tbody>
	                            </table>
	                            <div class="row">

							</div>
	                        </div>
	                    </div>
	                    <!-- END EXAMPLE TABLE PORTLET-->
	                </div>
	            </div>
	            <!-- END PAGE CONTENT-->
	        </div>
        </div>
	</div>
</div>
<script src="__PUBLIC__/Home/interact/js/jquery.form.js" type="text/javascript"></script>
<script>
//修改状态
function changeStatus(obj){
	var url = "{:U('Player/changeStatus')}";
	var id = $(obj).attr("id");
	var status = $(obj).attr("status");
	$.ajax({
		url:url,
		data:{status:status,id:id},
		type:'post',
		dataType:'json',
		success:function(msg){
			if(msg.code==1){
				location.replace(location.href);
			}else{
				alert(msg.msg);
			}
		}
	});
}
	$(function () {
		//实例化原型
		var track = new Track();
		//检查运单号导入状态
		track.setTrackName();
		//导入运单号
		$(".importTrack").on('click',function () {
			track.importTrack();
		})
		//运单号入库
		$(".writeTrack").on('click',function () {
			track.writeTrack();
		})
		//删除运单号
		$(".deleteTrack").on('click',function () {
			track.deleteTrack();
		})
		//初始化运单号
		$(".initTrack").on('click',function () {
			track.initTrack();
		})

	})
	//原型
	function Track() {}
	//原型扩展
	Track.prototype = {
		//写入文件名
		setTrackName : function () {
			var name = $.cookie('importTrack');
			name ? $(".trackName").html(name) : $(".trackName").html('未导入');
		},

		//导入运单号
		importTrack : function () {
			var $this = this;
			var html =  '<form id="import" action="{:U("Track/importTrack")}" method="post" enctype="multipart/form-data">';
				html += '<input type="file" name="download" class="importFile" style="padding: 30px">';
				html += '</form>';
			var options = {
				width : 400,
				height : 200,
				border : 0,
				title : '上传文件',
				bottomText : '仅支持txt后缀文件',
				submit : function () {
					var str = $(".importFile").val();
					var str_extend = str.substr(str.indexOf("."));
					var str_name   = str.substr(str.lastIndexOf("\\")+1);
					if(str_extend != '.txt') {
						$.jBox('html:上传文件格式有误!',{height:100,title:'警告',border:0,bottomText:'暂不支持'+str_extend+'格式'});
					} else {
						var uid = "{$UID}";
						$("#import").ajaxSubmit({
							type: 'post',
							url: "{:U('File/uploadPicture')}",
							data:{uid:uid},
							dataType: 'json',
							success : function (msg) {
								if(msg.status == 1) {
									var path  = msg.path;
									$.cookie('importTrack',str_name,{expires:1});
									$.cookie('importTrackPath',path,{expires:1});
									$this.setTrackName();
								} else {
									$.jBox('html:文件过大!');
								}
							},
							error : function () {console.log('error');}
						})
					}
				}
			}
			$.jBox(html,options);
		},

		//写入运单号
		writeTrack : function () {
			var fileName = $.cookie('importTrackPath');
			if(fileName) {
				$.ajax({
					url : "{:U('Player/writePlay')}",
					type : 'POST',
					data : {fileName : fileName},
					dataType : 'json',
					success : function (msg) {
						console.log(msg);
						if(msg.code == 1) {
							location.reload();
						} else {
							$.jBox('html:写入失败,重新尝试！');
						}
					}
				})
			} else { $.jBox('html:未导入运单号,尝试重新导入！');}
		},

		//删除运单号
		deleteTrack : function () {
			$.confirm({
				title : '确认删除？',
				modal: true,
				level:"warning",
				buttons: {
					"确定": {
						"class":"green",
						"action":function(){
							$.ajax({
								url : "{:U('Player/deletePlayer')}",
								type : 'GET',
								data : {fileName:$.cookie('importTrackPath')},
								dataType : 'json',
								success : function (msg) {
									console.log(msg);
									if(msg.code == 1) {
										$.cookie('importTrack','',{expires:-1});
										$.cookie('importTrackPath','',{expires:-1});
										location.reload();
									} else {
										$.jBox('html:删除失败！');
									}
								}
							})
						}
					},
					"取消": {
						"class":"green",
						"action":function() {}
					}
				}
			})
		},
		
		//初始化数据到缓存
		initTrack : function () {
			$.confirm({
				title : '确认初始化已导入的运单号？',
				modal: true,
				level:"warning",
				buttons: {
					"确定": {
						"class":"green",
						"action":function(){
							$.ajax({
								url : "{:U('Track/initTrack')}",
								type : 'GET',
								dataType : 'json',
								success : function (msg) {
									console.log(msg);
									if(msg.code == 1) {
										location.reload();
									} else {
										$.jBox('html:初始化失败！');
									}
								}
							})
						}
					},
					"取消": {
						"class":"green",
						"action":function() {}
					}
				}
			})
		}

	}
</script>
<include file="Public/footer" />