<include file="Public/head" />
<include file="Public/top" />
<div class="clearfix">
    <div class="page-container">
    <include file="Public/left" />
        <div class="page-content-wrapper">
	        <div class="page-content">
	            <!-- BEGIN SAMPLE PORTLET CONFIGURATION MODAL FORM-->
	            <div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="portlet-config" class="modal fade">
	                <div class="modal-dialog">
	                    <div class="modal-content">
	                        <div class="modal-header">
	                            <button aria-hidden="true" data-dismiss="modal" class="close" type="button"></button>
	                            <h4 class="modal-title">Modal title</h4>
	                        </div>
	                        <div class="modal-body">
	                             Widget settings form goes here
	                        </div>
	                        <div class="modal-footer">
	                            <button class="btn blue" type="button">Save changes</button>
	                            <button data-dismiss="modal" class="btn default" type="button">Close</button>
	                        </div>
	                    </div>
	                    <!-- /.modal-content -->
	                </div>
	                <!-- /.modal-dialog -->
	            </div>
	            <!-- /.modal -->
	            <!-- END SAMPLE PORTLET CONFIGURATION MODAL FORM-->
	            <!-- BEGIN PAGE HEADER-->
	            <!-- BEGIN PAGE HEAD -->
	            <div class="page-head">
	                <!-- BEGIN PAGE TITLE -->
	                <!-- END PAGE TITLE -->
	            </div>
	            <!-- END PAGE HEAD -->
	            <!-- BEGIN PAGE BREADCRUMB -->
	            <!-- END PAGE BREADCRUMB -->
	            <!-- END PAGE HEADER-->
	            <!-- BEGIN PAGE CONTENT-->
	            <div class="row">
	                <div class="col-md-12">
	                    <div class="portlet box">
	                    <div class="portlet-body form">

								<form role="form" class="form-horizontal" method="post" action="{:U('Player/index',array('type'=>$type,'stage_id'=>$stage_id))}">
								<div class="form-body">
									<div class="form-group">
										<label class="col-md-1 control-label">名称：</label>
										<div class="col-md-2">
											<input type="text" placeholder="名称" name="name" class="form-control input-small" value="{$name}">
										</div>
										<label class="col-md-1 control-label">编号：</label>
										<div class="col-md-2">
											<input type="text" placeholder="编号" name="number" class="form-control input-small" value="{$number}">
										</div>
										<!-- 
										<if condition="$type eq 0">
											<label class="col-md-1 control-label">是否VIP</label>
										<div class="col-md-2">
											<select class="form-control input-inline input-small" name="is_vip">
												<option value="-1" <if condition="$is_vip eq -1">selected</if>>全部</option>
												<option value="1" <if condition="$is_vip eq 1">selected</if>>是</option>
												<option value="0" <if condition="$is_vip eq 0">selected</if>>否</option>
											</select>
										</div>
										</if> -->
										<div class="col-md-2">
										<input type="hidden" name="type" value="{$type}"/>
											<button class="btn blue" type="submit">查询</button>
											<button class="btn default" type="reset">重置</button>
											<button class="btn default resetSort" type="button" stage_id="{$stage_id}">重置排序</button>
										</div>
									</div>
									
								</div>
							</form>

						</div>
	                    </div>
	                </div>
	            </div>
	            <div class="row">
	                <div class="col-md-12">
	                    <!-- BEGIN EXAMPLE TABLE PORTLET-->
	                    <div class="portlet box blue">
	                        <div class="portlet-title">
	                            <div class="caption">
	                                 <i class="fa fa-edit"></i>百人团/选手管理
	                            </div>
	                        </div>
	                        <div class="portlet-body">
	                        <ul class="nav nav-tabs ">
                                    <li <if condition="$type eq 0">class="active"</if>>
                                        <a  href="{:U('Player/index',array('type'=>0,'stage_id'=>$stage_id))}" aria-expanded="ture">百人团</a>
                                    </li>
                                    <li <if condition="$type eq 1">class="active"</if>>
                                        <a  href="{:U('Player/index',array('type'=>1,'stage_id'=>$stage_id))}" aria-expanded="ture">选手</a>
                                    </li>
                                    <li <if condition="$type eq 3">class="active"</if>>
                                        <a  href="{:U('Player/index',array('type'=>3,'stage_id'=>$stage_id))}" aria-expanded="ture">艺术家</a>
                                    </li>
                                    <li <if condition="$type eq 4">class="active"</if>>
                                        <a  href="{:U('Player/index',array('type'=>4,'stage_id'=>$stage_id))}" aria-expanded="ture">主持人</a>
                                    </li>
                                    <li <if condition="$type eq 5">class="active"</if>>
                                        <a  href="{:U('Player/index',array('type'=>5,'stage_id'=>$stage_id))}" aria-expanded="ture">嘉宾</a>
                                    </li>
                                  
                                    
                                </ul>
	                        	<a style="margin-bottom:5px;" class="btn btn-default importTrack" data-toggle="modal">导入</a><span class="trackName"></span>
	                        	<a style="margin-bottom:5px;" class="btn btn-default writeTrack" data-toggle="modal">写入信息</a>
								<a style="margin-bottom:5px;" class="btn btn-default deleteTrack" data-toggle="modal">删除信息</a>
	                        	<table class="table table-striped table-hover table-bordered">
	                                <thead>
	                                    <tr>
	                                    	<if condition="$type eq 0"><th>排名</th></if>
	                                        <th>座位编号</th>
	                                        <th>个人ID</th>
	                                        <th>名称</th>
	                                        <th>头像</th>
	                                   <!--      <if condition="$type lt 4"><th>答对题数</th></if>
	                                        <if condition="$type eq 1"><th>分数</th></if>
	                                        <if condition="$type eq 0 or $type eq 3 or $type eq 1">
		                                        <th>答题用时</th>
	                                        </if>-->
	                                        <if condition="$type eq 0"><th>排序</th></if>
	                                        <if condition="$type eq 1"><th>操作</th></if>
	                                        
	                                    </tr>
	                                </thead>
	                                <tbody>
							<notempty name="_list">
								<volist name="_list" id="vo"  key="k">
									<tr>
										<if condition="$type eq 0"><td><span <if condition="$k + 15*($p-1) elt 6">style="color:red;font-weight: bold"</if>>{$k + 15*($p-1)}</span></td></if>
										<td>{$vo.number}</td>
										<td><input type="text" value="{$vo.player_id}" pid="{$vo.id}" changeName='player_id' disabled style="text-align:center" class="playerChange dbClick"></td>
										<td><input type="text" value="{$vo.name}" pid="{$vo.id}" changeName='name' disabled style="text-align:center" class="playerChange dbClick"></td>
										<td><a href="{$head_img_url}{$vo.player_id}.png" target="_blank"><img src="{$head_img_url}{$vo.player_id}.png" style="text-align:center;width: 50px;height: 50px;"></a></td>
										 <!-- <if condition="$type lt 4"><td>{$vo.right_num}</td></if>
										<if condition="$type eq 1"><td>{$vo.score}</td></if>
										<if condition="$type eq 0 or $type eq 3 or $type eq 1"><td>{$vo.duration}</td></if>-->
										
										<if condition="$type eq 0">
											<td align="center"><input style="text-align:center" text="text" disabled class="clickRatio dbClick" id="{$vo.id}" value="{$vo.sort}" /></td>
										</if>	
										
										<if condition="$type eq 1">
											<td>
											<!-- 
												<if condition="$type eq 0">
													<if condition="$vo.is_vip eq 0">
														<a href="javascript:void(0);" id="{$vo.id}" status=1 type="vip" onclick="changeStatus(this)">VIP</a>
													<elseif condition="$vo.is_vip eq 1"/>
														<a href="javascript:void(0);" id="{$vo.id}" status=0 type="vip"  onclick="changeStatus(this)">取消VIP</a>
													</if>
												<else/> -->
													<if condition="$vo.is_start eq 0">
														<a href="javascript:void(0);" id="{$vo.id}" status=1 type="start" onclick="changeStatus(this)">开启</a>
													<elseif condition="$vo.is_start eq 1"/>
														<a href="javascript:void(0);" id="{$vo.id}" status=0 type="start" style="color:red;"  onclick="changeStatus(this)">关闭</a>
													</if>	
												<!-- </if> -->
											</td>
										</if>
									</tr>
								</volist>
								<else/>
								<td colspan="9" class="text-center"> aOh! 暂时还没有内容! </td>
								</notempty>
	                                </tbody>
	                            </table>
	                            <div class="row">
								
								<div class="col-md-5 col-sm-12">
									<div class="dataTables_info" id="sample_editable_1_info" role="status" aria-live="polite">
									    当前是第 {$p} 页  总页数 {$totalpage}
									</div>
								</div>
								<div class="col-md-7 col-sm-12">
									<div class="dataTables_paginate paging_simple_numbers" id="sample_editable_1_paginate">
										  {$page}
									 </div>
								</div>
							</div>
	                        </div>
	                    </div>
	                    <!-- END EXAMPLE TABLE PORTLET-->
	                </div>
	            </div>
	            <!-- END PAGE CONTENT-->
	        </div>
        </div>
	</div>
</div>
<script src="__PUBLIC__/Home/interact/js/jquery.form.js" type="text/javascript"></script>
<script>
//修改状态
function changeStatus(obj){
	var url = "{:U('Player/changeStatus')}";
	var id = $(obj).attr("id");
	var status = $(obj).attr("status");
	var type = $(obj).attr("type");
	$.ajax({
		url:url,
		data:{status:status,id:id,type:type},
		type:'post',
		dataType:'json',
		beforeSend: function () {
	        // 禁用按钮防止重复提交
	        $(obj).attr({ disabled: "disabled" });
	        $.refreshWindow.open("请稍后...");
	    },
		success:function(msg){
			$.refreshWindow.close();
			if(msg.code==1){
				location.replace(location.href);
			}else{
				alert(msg.message);
			}
		}
	});
}
	$(function () {
		//重置排序
		$(".resetSort").on('click',function () {
			$.ajax({
				url:"{:U('Player/resetSort')}",
				type:'post',
				data:{stage_id:$(this).attr('stage_id')},
				dataType:'json',
				success:function(msg) {
					console.log(msg);					
					$.confirm({title:msg.message,modal: true,buttons: {
							"确定": {"class":"green", "action":function() {}}
						}
					});
				},
				error: function() {
					console.log('reset Sort error')
				}
			})
		})

		//更新名字
		$(".dbClick").live('dblclick',function() {
			$(this).removeAttr('disabled');
		})

		$(".playerChange").on('blur',function() {
			var changeName = $(this).attr('changeName');
			var changeValue = $(this).val();
			var id = $(this).attr('pid');
			var $this = $(this);
			if (changeName && id) {
				$.ajax({
					url:"{:U('Player/updateName')}",
					type:'post',
					data:{changeName:changeName,changeValue:changeValue,id:id},
					dataType:'json',
					success:function(msg) {
						console.log(msg);
						$this.attr('disabled',true);
						if(msg.code == 1) {
							alert(msg.message);
							//location.reload();
						} else {
							$.confirm({title:msg.info,modal: true, level:"danger",buttons: {
									"确定": {"class":"green", "action":function() {}}
								}
							});
						}
					},
					error:function() {
						console.log('update name error');
					}
				})
			}
		})

		//更新点击数系数
		$(".clickRatio").on('blur',function(){
			var sort = $(this).val();
			var id = $(this).attr('id');
			var $this = $(this);
			if((/^(\+|-)?\d+$/.test(sort)) && sort >= 0) {  
				 $.ajax({
					url:"{:U('Player/changeSort')}",
					type:'post',
					data:{sort:sort,id:id},
					dataType:'json',
					success:function(msg){
						console.log(msg);
						$this.attr('disabled',true);
						if(msg.code == 1) {
							alert(msg.message);
							//location.reload();
						} else {
							$.confirm({title:msg.info,modal: true, level:"danger",buttons: {
									"确定": {"class":"green", "action":function() {}}
								}
							});
						}
					}
				});
			} else {  
				$.confirm({title:'参数不合法',modal: true, level:"danger",buttons: {
						"确定": {"class":"green", "action":function() {}}
					}
				});
				return false;
			}  
		})
		
		//实例化原型
		var track = new Track();
		//检查运单号导入状态
		track.setTrackName();
		//导入运单号
		$(".importTrack").on('click',function () {
			track.importTrack();
		})
		//运单号入库
		$(".writeTrack").on('click',function () {
			track.writeTrack();
		})
		//删除运单号
		$(".deleteTrack").on('click',function () {
			track.deleteTrack();
		})
		//初始化运单号
		$(".initTrack").on('click',function () {
			track.initTrack();
		})

	})
	//原型
	function Track() {}
	//原型扩展
	Track.prototype = {
		//写入文件名
		setTrackName : function () {
			var name = $.cookie('importTrack');
			name ? $(".trackName").html(name) : $(".trackName").html('未导入');
		},

		//导入运单号
		importTrack : function () {
			var $this = this;
			var html =  '<form id="import" action="{:U("Track/importTrack")}" method="post" enctype="multipart/form-data">';
				html += '<input type="file" name="download" class="importFile" style="padding: 30px">';
				html += '</form>';
			var options = {
				width : 400,
				height : 200,
				border : 0,
				title : '上传文件',
				bottomText : '仅支持txt后缀文件',
				submit : function () {
					var str = $(".importFile").val();
					var str_extend = str.substr(str.indexOf("."));
					var str_name   = str.substr(str.lastIndexOf("\\")+1);
					if(str_extend != '.txt') {
						$.jBox('html:上传文件格式有误!',{height:100,title:'警告',border:0,bottomText:'暂不支持'+str_extend+'格式'});
					} else {
						var uid = "{$UID}";
						$("#import").ajaxSubmit({
							type: 'post',
							url: "{:U('File/uploadPicture')}",
							data:{uid:uid},
							dataType: 'json',
							success : function (msg) {
								if(msg.status == 1) {
									var path  = msg.path;
									$.cookie('importTrack',str_name,{expires:1});
									$.cookie('importTrackPath',path,{expires:1});
									$this.setTrackName();
								} else {
									$.jBox('html:文件过大!');
								}
							},
							error : function () {console.log('error');}
						})
					}
				}
			}
			$.jBox(html,options);
		},

		//写入运单号
		writeTrack : function () {
			var fileName = $.cookie('importTrackPath');
			var type = {$type};
			if(fileName) {
				$.ajax({
					url : "{:U('Player/writePlay')}",
					type : 'POST',
					data : {fileName : fileName,type:type},
					dataType : 'json',
					beforeSend : function () {
						$(".writeTrack").addClass('disabled').text('正在写入...');
					},
					success : function (msg) {
						console.log(msg);
						if(msg.code == 1) {
							location.reload();
						} else {
							$.jBox('html:写入失败,重新尝试！');
						}
					}
				})
			} else { $.jBox('html:未导入名单,尝试重新导入！');}
		},

		//删除运单号
		deleteTrack : function () {
			var type = {$type};
			$.confirm({
				title : '确认删除？',
				modal: true,
				level:"warning",
				buttons: {
					"确定": {
						"class":"green",
						"action":function(){
							$.ajax({
								url : "{:U('Player/deletePlayer')}",
								type : 'GET',
								data : {fileName:$.cookie('importTrackPath'),type:type},
								dataType : 'json',
								success : function (msg) {
									console.log(msg);
									if(msg.code == 1) {
										$.cookie('importTrack','',{expires:-1});
										$.cookie('importTrackPath','',{expires:-1});
										location.reload();
									} else {
										$.jBox('html:删除失败！');
									}
								}
							})
						}
					},
					"取消": {
						"class":"green",
						"action":function() {}
					}
				}
			})
		},
		
		//初始化数据到缓存
		initTrack : function () {
			$.confirm({
				title : '确认初始化已导入的运单号？',
				modal: true,
				level:"warning",
				buttons: {
					"确定": {
						"class":"green",
						"action":function(){
							$.ajax({
								url : "{:U('Track/initTrack')}",
								type : 'GET',
								dataType : 'json',
								success : function (msg) {
									console.log(msg);
									if(msg.code == 1) {
										location.reload();
									} else {
										$.jBox('html:初始化失败！');
									}
								}
							})
						}
					},
					"取消": {
						"class":"green",
						"action":function() {}
					}
				}
			})
		}

	}
</script>
<include file="Public/footer" />
