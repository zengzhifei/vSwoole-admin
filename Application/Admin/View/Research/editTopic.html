<include file="Public/head" />
<include file="Public/top" />
<div class="clearfix">
	<div class="page-container">
	<include file="Public/left" />
	
	    <div class="page-content-wrapper">
<!-- BEGIN CONTAINER -->
<!-- <div class="page-container"> -->
	<!-- <div class="page-content-wrapper"> -->
		<div class="page-content">
			<!-- BEGIN SAMPLE PORTLET CONFIGURATION MODAL FORM-->
			<div class="modal fade" id="portlet-config" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
							<h4 class="modal-title">Modal title</h4>
						</div>
						<div class="modal-body">
							 Widget settings form goes here
						</div>
						<div class="modal-footer">
							<button type="button" class="btn blue">Save changes</button>
							<button type="button" class="btn default" data-dismiss="modal">Close</button>
						</div>
					</div>
					<!-- /.modal-content -->
				</div>
				<!-- /.modal-dialog -->
			</div>
			<!-- <ul class="page-breadcrumb breadcrumb">
				<li>
					<a href="index.html">首页</a>
					<i class="fa fa-circle"></i>
				</li>
				<li>
					<a href="{:addons_url('Research://Research/index')}">微调研</a>
					<i class="fa fa-circle"></i>
				</li>
				<li>
					<a href="#">编辑题目</a>
				</li>
			</ul> -->
			<div class="row">
				<div class="col-md-12">
					<!-- BEGIN VALIDATION STATES-->
					<div class="portlet box blue">
						<div class="portlet-title">
							<div class="caption">
								<i class="fa fa-gift"></i>调研题目设置
							</div>
							<div class="tools">
								<button class="btn btn-default" onclick="jumpurl()" type="button">返回</button>
							</div>
						</div>
						<div class="portlet-body form">
							<!-- BEGIN FORM-->
							<form  id="form_sample_1"  class="form-horizontal">
								<input type="hidden" name="researchid" value="{$topic.researchid}">
								<input type="hidden" name="topicid" value="{$topic.id}">
								<input type="hidden" name="removeOption" value="">
								<!-- <input type="hidden" name="type" value="{$type}"> -->
								<div class="form-body">
									<div class="alert alert-danger display-hide">
										<button class="close" data-close="alert"></button>
										您填写的表单信息有误，请检查一下！
									</div>
									<div class="alert alert-success display-hide">
										<button class="close" data-close="alert"></button>
										信息无误，验证通过！
									</div>
								 
								<div class="form-group" style="margin-top:10px;">
										<label class="control-label col-md-3">题目名称</label>
										<div class="col-md-9">
											<input type="text" name="title" placeholder="题目名称" class="form-control input-inline input-medium" value="{$topic.title}">
											<span class="required" style="color:red">* </span>
											<span class="help-inline">
											不能超过60个字</span>
										</div>
								</div> 
								<div name="option-list">
								<foreach name="option"  item="vo">
									<if condition="$key elt 1">
									<div class="form-group">
											<label class="control-label col-md-3">选项</label>
											<div class="col-md-9">
											    <input type='hidden' name="optionid[{$key+1}]"  value="{$vo.id}">
												<input type="text" name="optiontitle[{$key+1}]" id="optiontitle{$key+1}" class="form-control input-inline input-medium" value="{$vo.title}">
												<span class="required" style="color:red">* </span>
												<span class="help-inline">
												不能超过16个字符</span>
											</div>
									</div>
									<else />
									 <div class="form-group">
											<label class="control-label col-md-3">选项</label>
											<div class="col-md-9">
											    <input type='hidden' name="optionid[{$key+1}]"  value="{$vo.id}">
												<input type="text" name="optiontitle[{$key+1}]"  id="optiontitle{$key+1}"  class="form-control input-inline input-medium" value="{$vo.title}">
												<button class="btn btn-danger" onclick="deloption(this,{$vo.id})" rel="{$key+1}"   type="button">删除</button>
												<span class="help-inline">
												不能超过16个字符</span>
											</div>
									</div>
									</if>
								</foreach>
								</div>
								<div class="form-group">
										<label class="control-label col-md-3"></label>
										<div class="col-md-9">
											<button type="button" class="btn btn-default" onclick="addoption()">+添加选项</button>
										</div>
								</div> 
								<div class="form-group">
										<label class="control-label col-md-3">题目答案最多数目</label>
										<div class="col-md-9">
											<select class="form-control input-inline input-medium" name="answer_number">
												
											
											</select>
											<span class="required" style="color:red">* </span>
										</div>
								</div>
								<div class="form-actions">
									<div class="row">
										<div class="col-md-offset-5 col-md-7">
											<button type="submit" class="btn blue">保存</button>
											<button type="reset" class="btn default">重置</button>
										</div>
									</div>
								</div>
							</form>
							<!-- END FORM-->
						</div>
					</div>
					<!-- END VALIDATION STATES-->
				</div>
			</div>
			<!-- END PAGE CONTENT-->
		</div>
		</div>
		</div>
		
<script type="text/javascript" src="__PUBLIC__/Home/static/theme/assets/global/plugins/jquery-validation/js/jquery.validate.min.js"></script>
<!-- END PAGE LEVEL STYLES -->
<script>
jQuery(document).ready(function() {   
addselect();
$("[name='removeOption']").val('');
});
</script>
<script>
    function addoption(){
    	var i=1;
    	$("[name='option-list']").find(".form-group").each(function(){
    		i++;
    	});
    	html = '<div class="form-group">';
    	html+= '<label class="control-label col-md-3">选项</label><div class="col-md-9">';
    	html+= '<input type="text" id="optiontitle'+i+'" name="optiontitle['+i+']"  class="form-control input-inline input-medium"><button class="btn btn-danger"  onclick="deloption(this,false)" rel="'+i+'"  type="button">删除</button>';
    	html+= '<span class="help-inline">不能超过16个字符</span></div></div>';
    	$("[name='option-list']").append(html);
    	addselect();
    }
    function deloption(obj,optionid){
    	if(optionid){
    	    var optionidstr = $("[name='removeOption']").val();
    		if(optionidstr){
    			optionid = optionidstr+','+optionid;
    			$("[name='removeOption']").val(optionid);
    		}else{
    			$("[name='removeOption']").val(optionid);
    		}
    		$(obj).parent().parent().remove();
    		addselect();
    	}else{
    		$(obj).parent().parent().remove();
    		addselect();
    	}
    	
    	
    }
    function addselect(){
    	var i=1;
    	$("[name='option-list']").find(".form-group").each(function(){
    		i++;
    	});
    	var s = {$topic.answer_number};
    	var html='';
    	for(var key=1;key<i;key++){
    		if(key==s){
    			html += '<option selected value="'+key+'" >'+key+'</option>';
    		}else{
    			html+='<option value="'+key+'" >'+key+'</option>';
    		}
    		
    	}
    	$("[name='answer_number']").html(html)
    }
	function formsubmit(){
		var data=$("#form_sample_1").serialize();
		$.ajax({
			url:"{:U('Research/saveTopic')}",
			data:data,
			type:"POST",
			dataType:"json",
			success:function(msg){
				if(msg.status == 1){
					var msg = msg.info+",页面在三秒后自动跳转!!!";
					$.confirm({title:msg,modal: true, level:"success",buttons: {  
						   "确定": {
							   "class":"green",
							   "action":function() {
								   jumpurl();
							   }
						   }
					   }  
					});
					setTimeout("jumpurl()",3000);
				}else{
					var msg=msg.info+"请重新提交";
					$.confirm({title:msg,modal: true, level:"danger",buttons: {  
						   "确定": {
							   "class":"green",
							   "action":function() {
							   }
						   }
					   }  
					});
				}
			}
		});
		return false;
	}
	function jumpurl(){
		var str = "{:U('Research/topicList')}";
		var url = str.replace(".html","")
		    url = url+"/researchid/"+{$topic.researchid};
		    location.href=url;
	}
	
	
	
	jQuery(document).ready(function(){
		var form2 = $('#form_sample_1');
        var error2 = $('.alert-danger', form2);
        var success2 = $('.alert-success', form2);
        form2.validate({
            errorElement: 'span', //default input error message container
            errorClass: 'help-inline', // default input error message class
            focusInvalid: false, // do not focus the last invalid input
            ignore: "",
            rules: {
            	title: {
                    minlength: 1,
                    maxlength: 180,
                    required: true,
                },
                answer_number: {
                    required: true,
                },
            },
            invalidHandler: function (event, validator) { //display error alert on form submit              
                success2.hide();
                error2.show();
            },

            errorPlacement: function (error, element) { // render error placement for each input type
                var icon = $(element).parent('.input-icon').children('i');
                icon.removeClass('fa-check').addClass("fa-warning");  
                icon.attr("data-original-title", error.text()).tooltip({'container': 'body'});
            },

            highlight: function (element) { // hightlight error inputs
                $(element).closest('.form-group').addClass('has-error'); // set error class to the control group   
            },

            unhighlight: function (element) { // revert the change done by hightlight
                
            },

            success: function (label, element) {
                var icon = $(element).parent('.input-icon').children('i');
                $(element).closest('.form-group').removeClass('has-error').addClass('has-success'); // set success class to the control group
                icon.removeClass("fa-warning").addClass("fa-check");
            },

            submitHandler: function (form) {
                //success2.show();
                error2.hide();
                if(checkoptiontitle() == true){
                	formsubmit()
                }
                
            }
        });
        return false;
	});
	
	function checkoptiontitle(){
		var j=0;
		var b=0;
		for(var i=1;i<=$("[name='option-list']").find(".form-group").length;i++){
			var optiontitle = $("#optiontitle"+i).val();
			if(i<=2){
				if(optiontitle == '' || optiontitle.length>48){
					$("#optiontitle"+i).parent().parent().closest('.form-group').addClass('has-error');
					$('.alert-danger').show();
					$('.alert-success').hide();
					return false;
				}else{
					$("#optiontitle"+i).parent().parent().closest('.form-group').removeClass('has-error').addClass('has-success');
					$('.alert-danger').hide();
					$('.alert-success').show();
					b++;
					//success=true;
				}
			}else{
				if(optiontitle.length>48){
					$("#optiontitle"+i).parent().parent().closest('.form-group').addClass('has-error');
					$('.alert-danger').show();
					$('.alert-success').hide();
					return false;
				}else{
					$("#optiontitle"+i).parent().parent().closest('.form-group').removeClass('has-error').addClass('has-success');
					$('.alert-danger').hide();
					$('.alert-success').show();
					b++;
					//success=true;
				}
			}
			j++;
		}
		/*$("[name='option-list']").find(".form-group").each(function(l,obj){
			//var success=false;
			i++;
			var optiontitle = $("#optiontitle"+i).val();
			if(optiontitle == '' || optiontitle.length>48){
				obj.closest('.form-group').addClass('has-error');
				$('.alert-danger').show();
				$('.alert-success').hide();
				return false;
			}else{
				obj.closest('.form-group').removeClass('has-error').addClass('has-success');
				$('.alert-danger').hide();
				$('.alert-success').show();
				b++;
				//success=true;
			}
			//return success;
		});*/
		if(b==j){
			return true;
		}else{
			return false;
		}
	}
</script>

<include file="Public/footer" />