<include file="Public/head"/>
<include file="Public/top"/>
<div class="clearfix">
    <div class="page-container">
        <include file="Public/left"/>

        <div class="page-content-wrapper">
            <div class="page-content">
                <!-- BEGIN SAMPLE PORTLET CONFIGURATION MODAL FORM-->
                <div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="portlet-config"
                     class="modal fade">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button aria-hidden="true" data-dismiss="modal" class="close" type="button"></button>
                                <h4 class="modal-title">Modal title</h4>
                            </div>
                            <div class="modal-body">
                                Widget settings form goes here
                            </div>
                            <div class="modal-footer">
                                <button class="btn blue" type="button">Save changes</button>
                                <button data-dismiss="modal" class="btn default" type="button">Close</button>
                            </div>
                        </div>
                        <!-- /.modal-content -->
                    </div>
                    <!-- /.modal-dialog -->
                </div>
                <!-- /.modal -->
                <!-- END SAMPLE PORTLET CONFIGURATION MODAL FORM-->
                <!-- BEGIN PAGE HEADER-->
                <!-- BEGIN PAGE HEAD -->
                <div class="page-head">
                    <!-- BEGIN PAGE TITLE -->
                    <!-- END PAGE TITLE -->
                    <!-- BEGIN PAGE TOOLBAR -->
                    <!--<div class="page-toolbar">
                         BEGIN THEME PANEL
                        <div class="btn-group btn-theme-panel">
                            <a data-toggle="dropdown" class="btn dropdown-toggle" href="javascript:;">
                            <i class="icon-settings"></i>
                            </a>
                            <div class="dropdown-menu theme-panel pull-right dropdown-custom hold-on-click">
                                <div class="row">
                                    <div class="col-md-4 col-sm-4 col-xs-12">
                                        <h3>THEME</h3>
                                        <ul class="theme-colors">
                                            <li data-theme="default" class="theme-color theme-color-default active">
                                                <span class="theme-color-view"></span>
                                                <span class="theme-color-name">Dark Header</span>
                                            </li>
                                            <li data-theme="light" class="theme-color theme-color-light">
                                                <span class="theme-color-view"></span>
                                                <span class="theme-color-name">Light Header</span>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="col-md-8 col-sm-8 col-xs-12 seperator">
                                        <h3>LAYOUT</h3>
                                        <ul class="theme-settings">
                                            <li>
                                                 Theme Style
                                                <select class="layout-style-option form-control input-small input-sm">
                                                    <option selected="selected" value="square">Square corners</option>
                                                    <option value="rounded">Rounded corners</option>
                                                </select>
                                            </li>
                                            <li>
                                                 Layout
                                                <select class="layout-option form-control input-small input-sm">
                                                    <option selected="selected" value="fluid">Fluid</option>
                                                    <option value="boxed">Boxed</option>
                                                </select>
                                            </li>
                                            <li>
                                                 Header
                                                <select class="page-header-option form-control input-small input-sm">
                                                    <option selected="selected" value="fixed">Fixed</option>
                                                    <option value="default">Default</option>
                                                </select>
                                            </li>
                                            <li>
                                                 Top Dropdowns
                                                <select class="page-header-top-dropdown-style-option form-control input-small input-sm">
                                                    <option value="light">Light</option>
                                                    <option selected="selected" value="dark">Dark</option>
                                                </select>
                                            </li>
                                            <li>
                                                 Sidebar Mode
                                                <select class="sidebar-option form-control input-small input-sm">
                                                    <option value="fixed">Fixed</option>
                                                    <option selected="selected" value="default">Default</option>
                                                </select>
                                            </li>
                                            <li>
                                                 Sidebar Menu
                                                <select class="sidebar-menu-option form-control input-small input-sm">
                                                    <option selected="selected" value="accordion">Accordion</option>
                                                    <option value="hover">Hover</option>
                                                </select>
                                            </li>
                                            <li>
                                                 Sidebar Position
                                                <select class="sidebar-pos-option form-control input-small input-sm">
                                                    <option selected="selected" value="left">Left</option>
                                                    <option value="right">Right</option>
                                                </select>
                                            </li>
                                            <li>
                                                 Footer
                                                <select class="page-footer-option form-control input-small input-sm">
                                                    <option value="fixed">Fixed</option>
                                                    <option selected="selected" value="default">Default</option>
                                                </select>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                         END THEME PANEL
                    </div> -->
                    <!-- END PAGE TOOLBAR -->
                </div>
                <!-- END PAGE HEAD -->
                <!-- BEGIN PAGE BREADCRUMB -->
                <!-- <ul class="page-breadcrumb breadcrumb">
                    <li>
                        <a href="#">竞猜</a>
                        <i class="fa fa-circle"></i>
                    </li>
                </ul> -->
                <!-- END PAGE BREADCRUMB -->
                <!-- END PAGE HEADER-->
                <!-- BEGIN PAGE CONTENT-->
                <!-- 注释 查询开始  -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="portlet box">
                            <div class="portlet-body form">
                                <form role="form" class="form-horizontal">
                                    <div class="form-body">
                                        <div class="form-group">
                                            <label class="col-md-1 control-label">类型：</label>
                                            <div class="col-md-3" style="width: 18% !important;">
                                                <label><input type="radio" name="qa-lucky-list-type" class="form-control input-small" value="1"
                                                    <if condition="$qa_lucky_list_type eq 1">checked</if>
                                                    >当前轮</label>
                                                <label><input type="radio" name="qa-lucky-list-type" class="form-control input-small" value="2"
                                                    <if condition="$qa_lucky_list_type eq 2">checked</if>
                                                    >当前期</label>
                                                <label><input type="radio" name="qa-lucky-list-type" class="form-control input-small" value="3"
                                                    <if condition="$qa_lucky_list_type eq 3">checked</if>
                                                    >总体</label>
                                            </div>
                                            <label class="col-md-2 control-label" style="width: 11% !important;">抽奖排名区间：</label>
                                            <div class="col-md-4" style="width: 28% !important;">
                                                <input type="text" name="ranking-start" class="form-control input-small" value="1" placeholder="起始排名" style="display: inline-block;">至
                                                <input type="text" name="ranking-end" class="form-control input-small" placeholder="正整数" style="display: inline-block;">
                                            </div>
                                            <label class="col-md-1 control-label">生成总数：</label>
                                            <div class="col-md-2">
                                                <input type="text" name="qa-lucky-list-number" class="form-control input-small" placeholder="正整数" style="display: inline-block;">
                                            </div>
                                            <div class="col-md-1">
                                                <button class="btn blue" type="button" column_id="{$column_id}" stage_id="{$stage_id}" group_id="{$group_id}" id="qa-lucky-list-create">生成</button>
                                            </div>
                                        </div>
                                    </div>
                                </form>

                            </div>
                        </div>
                    </div>
                </div>
                <!-- 注释 查询结束  -->
                <div class="row">
                    <div class="col-md-12">
                        <!-- BEGIN EXAMPLE TABLE PORTLET-->
                        <div class="portlet box blue">
                            <div class="portlet-title">
                                <div class="caption">
                                    <i class="fa fa-edit"></i>{$title}
                                </div>
                            </div>
                            <div class="portlet-body">
                                <button style="margin-bottom:5px;" class="btn blue qa-lucky-list-delete" type="button" id="qa-lucky-list-delete">批量删除</button>
                                <button style="margin-bottom:5px;" class="btn blue" type="button" id="qa-lucky-list-ok">确认生成</button>
                                <button style="margin-bottom:5px;" class="btn blue" type="button" id="qa-lucky-list-export">导出列表</button>
                                <table class="table table-striped table-hover table-bordered" id="sample_editable_1">
                                    <thead>
                                    <tr>
                                        <th><input type="checkbox" id="checkAll" class="select"></th>
                                        <th>序号</th>
                                        <th>排名</th>
                                        <th>头像</th>
                                        <th>昵称</th>
                                        <th>ID</th>
                                        <th>手机</th>
                                        <th>城市</th>
                                        <th>是否确认</th>
                                        <th>是否领奖</th>
                                        <th>操作</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <notempty name="lucky_user_list">
                                        <foreach name="lucky_user_list" item="vo" key="key">
                                            <tr>
                                                <td><input type="checkbox" id="{$vo.id}" class="select"></td>
                                                <td>{$p * 15 - 15 + $key + 1}</td>
                                                <td>{$vo.user_ranking}</td>
                                                <td>
                                                    <if condition="$vo.user_head neq ''">
                                                        <img src="{$vo.user_head}" style="width: 50px;height: 50px;">
                                                    </if>
                                                </td>
                                                <td>{$vo.user_name}</td>
                                                <td>{$vo.user_id}</td>
                                                <td>{$vo.user_phone}</td>
                                                <td>{$vo.user_city}</td>
                                                <td>
                                                    <if condition="$vo.user_status eq 1">
                                                        <span style="color: red;">已确认</span>
                                                        <else/>
                                                        未确认
                                                    </if>
                                                </td>
                                                <td>
                                                    <if condition="$vo.user_lucky_status eq 1">
                                                        <span style="color: red;">已领取</span>
                                                        <else/>
                                                        未领取
                                                    </if>
                                                </td>
                                                <td>
                                                    <a><i lucky_id="{$vo.id}" class="glyphicon glyphicon-trash qa-lucky-list-delete" title="删除"></i></a>
                                                </td>
                                            </tr>
                                        </foreach>
                                        <else/>
                                        <td colspan="11" class="text-center"> aOh! 暂时还没有内容!</td>
                                    </notempty>
                                    </tbody>
                                </table>
                                <div class="row">
                                    <div class="col-md-5 col-sm-12">
                                        <div class="dataTables_info" id="sample_editable_1_info" role="status"
                                             aria-live="polite">
                                            当前是第 {$p} 页 总页数 {$totalPage}
                                        </div>
                                    </div>
                                    <div class="col-md-7 col-sm-12">
                                        <div class="dataTables_paginate paging_simple_numbers"
                                             id="sample_editable_1_paginate">
                                            {$show}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- END EXAMPLE TABLE PORTLET-->
                    </div>
                </div>

                <!-- END PAGE CONTENT-->
            </div>
        </div>
    </div>
</div>
<script>
    $(function () {
        //类型选择
        $("input[name='qa-lucky-list-type']").on('change', function () {
            var qa_lucky_list_type = $("input[name='qa-lucky-list-type']:checked").val();
            var column_id = $("#qa-lucky-list-create").attr('column_id');
            var stage_id = $("#qa-lucky-list-create").attr('stage_id');
            var group_id = $("#qa-lucky-list-create").attr('group_id');
            switch (parseInt(qa_lucky_list_type)) {
                case 1:
                    var url = "{:U('QaLucky/index')}" + "&qa_lucky_list_type=" + qa_lucky_list_type + "&group_id=" + group_id;
                    break;
                case 2:
                    var url = "{:U('QaLucky/index')}" + "&qa_lucky_list_type=" + qa_lucky_list_type + "&stage_id=" + stage_id;
                    break;
                case 3:
                    var url = "{:U('QaLucky/index')}" + "&qa_lucky_list_type=" + qa_lucky_list_type + "&column_id=" + column_id;
                    break;
                default:
                    var url = "{:U('QaLucky/index')}";
                    break;
            }
            location.href = url;
        })
        //全选/反选
        $('#checkAll').on('click', function () {
            if ($(this).parent().hasClass('checked')) {
                $(".select").parent().removeClass('checked');
            } else {
                $(".select").parent().addClass('checked');
            }
        })
        //批量删除
        $(".qa-lucky-list-delete").on('click', function () {
            var qa_lucky_list_type = $("input[name='qa-lucky-list-type']:checked").val();
            var column_id = $("#qa-lucky-list-create").attr('column_id');
            var stage_id = $("#qa-lucky-list-create").attr('stage_id');
            var group_id = $("#qa-lucky-list-create").attr('group_id');
            var ids = [];
            //批量
            if ($(this).attr('id') == 'qa-lucky-list-delete') {
                $.each($('.select'), function () {
                    if (($(this).attr('id') !== 'checkAll') && $(this).parent().hasClass('checked')) {
                        ids.push($(this).attr('id'));
                    }
                })
            } else {
                //单独
                ids.push($(this).attr('lucky_id'));
            }
            if (ids.length < 1) {
                $.confirm({
                    title: '你没有选择需要删除的选项！', modal: true, level: "danger", buttons: {
                        "确定": {
                            "class": "green", "action": function () {
                            }
                        }
                    }
                });
                return false;
            }

            $.confirm({
                title: '您确认删除所选用户吗？',
                modal: true,
                level: "warning",
                buttons: {
                    "确定": {
                        "class": "green",
                        "action": function () {
                            $.ajax({
                                url: "{:U('QaLucky/deleteLuckyUser')}",
                                type: 'post',
                                data: {lucky_user: ids, qa_lucky_list_type: qa_lucky_list_type, column_id: column_id, stage_id: stage_id, group_id: group_id},
                                dataType: 'json',
                                success: function (res) {
                                    if (res.status == 1) {
                                        $.each(ids, function (i, v) {
                                            $("#" + v).parent().parent().parent().parent().remove();
                                        })
                                    } else {
                                        $.confirm({
                                            title: '删除失败！', modal: true, level: "danger", buttons: {
                                                "确定": {
                                                    "class": "green", "action": function () {
                                                    }
                                                }
                                            }
                                        });
                                    }
                                }
                            });
                        }
                    },
                    "取消": {
                        "class": "green", "action": function () {
                        }
                    }
                }
            });
        })

        //生成列表
        $("#qa-lucky-list-create").on('click', function () {
            var qa_lucky_list_type = $("input[name='qa-lucky-list-type']:checked").val();
            var column_id = $(this).attr('column_id');
            var stage_id = $(this).attr('stage_id');
            var group_id = $(this).attr('group_id');
            var ranking_start = parseInt($("input[name='ranking-start']").val());
            var ranking_end = parseInt($("input[name='ranking-end']").val());
            var qa_lucky_list_number = parseInt($("input[name='qa-lucky-list-number']").val());
            var check = true;

            if (qa_lucky_list_type === undefined) {
                var title = '抽奖名单类型必须选择';
                check = false;
            } else if (!ranking_start || !ranking_end || !qa_lucky_list_number || ranking_start < 1 || ranking_end < 1 || qa_lucky_list_number < 1 || (ranking_start % 1) !== 0 || (ranking_end % 1) !== 0 || (qa_lucky_list_number % 1) !== 0) {
                var title = '抽奖排名区间和生成总数不能为空，且必须为大于等于1的正整数';
                check = false;
            } else if (ranking_start > ranking_end) {
                var title = '抽奖起始排名不能大于终止排名';
                check = false;
            } else if ((qa_lucky_list_number - 1) > (ranking_end - ranking_start)) {
                var title = '生成总数不能大于抽奖排名区间';
                check = false;
            }
            if (!check) {
                $.confirm({
                    title: title,
                    level: 'danger',
                    buttons: {
                        "确定": {
                            class: "blue"
                        }
                    }
                })
                return false;
            }
            $.ajax({
                url: "{:U('QaLucky/luckyListCreate')}",
                type: 'GET',
                data: {qa_lucky_list_type: qa_lucky_list_type, column_id: column_id, stage_id: stage_id, group_id: group_id, ranking_start: ranking_start, ranking_end: ranking_end, qa_lucky_list_number: qa_lucky_list_number},
                dataType: 'JSON',
                context: this,
                success: function (res) {
                    console.log(res);
                    if (res.status == 1) {
                        switch (parseInt(qa_lucky_list_type)) {
                            case 1:
                                var url = "{:U('QaLucky/index')}" + "&qa_lucky_list_type=" + qa_lucky_list_type + "&group_id=" + group_id;
                                break;
                            case 2:
                                var url = "{:U('QaLucky/index')}" + "&qa_lucky_list_type=" + qa_lucky_list_type + "&stage_id=" + stage_id;
                                break;
                            case 3:
                                var url = "{:U('QaLucky/index')}" + "&qa_lucky_list_type=" + qa_lucky_list_type + "&column_id=" + column_id;
                                break;
                            default:
                                var url = "{:U('QaLucky/index')}";
                                break;
                        }
                        location.href = url;
                    } else {
                        $.confirm({
                            title: res.msg,
                            level: 'warning',
                            buttons: {
                                "确定": {
                                    class: "blue"
                                }
                            }
                        })
                    }
                },
                error: function (e) {
                    $.confirm({
                        title: e.statusText,
                        level: 'warning',
                        buttons: {
                            "确定": {
                                class: "blue"
                            }
                        }
                    })
                }
            })
        })

        //确认生成
        $("#qa-lucky-list-ok").on('click', function () {
            var qa_lucky_list_type = $("input[name='qa-lucky-list-type']:checked").val();
            var column_id = $("#qa-lucky-list-create").attr('column_id');
            var stage_id = $("#qa-lucky-list-create").attr('stage_id');
            var group_id = $("#qa-lucky-list-create").attr('group_id');
            $.confirm({
                title: '确认当前中奖名单将会覆盖已确认的名单，是否确认？',
                level: 'warning',
                buttons: {
                    "确定": {
                        class: "blue",
                        action: function () {
                            $.ajax({
                                url: "{:U('QaLucky/syncQaLuckyUserList')}",
                                type: 'GET',
                                data: {qa_lucky_list_type: qa_lucky_list_type, column_id: column_id, stage_id: stage_id, group_id: group_id},
                                dataType: 'JSON',
                                success: function (res) {
                                    console.log(res);
                                    if (res.status == 1) {
                                        location.reload();
                                    } else {
                                        $.confirm({
                                            title: res.msg,
                                            level: 'danger',
                                            buttons: {
                                                "确定": {
                                                    class: "blue"
                                                }
                                            }
                                        })
                                    }
                                },
                                error: function (e) {
                                    $.confirm({
                                        title: e.statusText,
                                        level: 'warning',
                                        buttons: {
                                            "确定": {
                                                class: "blue"
                                            }
                                        }
                                    })
                                }
                            })
                        }
                    },
                    "取消": {
                        "class": "green",
                        "action": function () {
                        }
                    }
                }
            })
        })

        //导出
        $("#qa-lucky-list-export").on('click', function () {
            var qa_lucky_list_type = "{$qa_lucky_list_type}";
            var group_id = "{$group_id}";
            var stage_id = "{$stage_id}";
            var column_id = "{$column_id}";
            switch (parseInt(qa_lucky_list_type)) {
                case 1:
                    var url = "{:U('QaLucky/exportQaLuckyUserList')}" + "&qa_lucky_list_type=" + qa_lucky_list_type + "&group_id=" + group_id;
                    break;
                case 2:
                    var url = "{:U('QaLucky/exportQaLuckyUserList')}" + "&qa_lucky_list_type=" + qa_lucky_list_type + "&stage_id=" + stage_id;
                    break;
                case 3:
                    var url = "{:U('QaLucky/exportQaLuckyUserList')}" + "&qa_lucky_list_type=" + qa_lucky_list_type + "&column_id=" + column_id;
                    break;
                default:
                    var url = "{:U('QaLucky/index')}";
                    break;
            }
            location.href = url;
        })
    })
</script>

<include file="Public/footer"/>