<include file="Public/head"/>
<include file="Public/top"/>
<div class="clearfix">
    <div class="page-container">
        <include file="Public/left"/>
        <script src="__PUBLIC__/Home/interact/js/jquery.form.js" type="text/javascript"></script>
        <div class="page-content-wrapper">
            <div class="page-content">
                <!-- BEGIN SAMPLE PORTLET CONFIGURATION MODAL FORM-->
                <div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="portlet-config"
                     class="modal fade">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button aria-hidden="true" data-dismiss="modal" class="close" type="button"></button>
                                <h4 class="modal-title">Modal title</h4>
                            </div>
                            <div class="modal-body">
                                Widget settings form goes here
                            </div>
                            <div class="modal-footer">
                                <button class="btn blue" type="button">Save changes</button>
                                <button data-dismiss="modal" class="btn default" type="button">Close</button>
                            </div>
                        </div>
                        <!-- /.modal-content -->
                    </div>
                    <!-- /.modal-dialog -->
                </div>
                <!-- /.modal -->
                <!-- END SAMPLE PORTLET CONFIGURATION MODAL FORM-->
                <!-- BEGIN PAGE HEADER-->
                <!-- BEGIN PAGE HEAD -->
                <div class="page-head">
                    <!-- BEGIN PAGE TITLE -->
                    <!-- END PAGE TITLE -->
                    <!-- BEGIN PAGE TOOLBAR -->
                    <!--<div class="page-toolbar">
                         BEGIN THEME PANEL
                        <div class="btn-group btn-theme-panel">
                            <a data-toggle="dropdown" class="btn dropdown-toggle" href="javascript:;">
                            <i class="icon-settings"></i>
                            </a>
                            <div class="dropdown-menu theme-panel pull-right dropdown-custom hold-on-click">
                                <div class="row">
                                    <div class="col-md-4 col-sm-4 col-xs-12">
                                        <h3>THEME</h3>
                                        <ul class="theme-colors">
                                            <li data-theme="default" class="theme-color theme-color-default active">
                                                <span class="theme-color-view"></span>
                                                <span class="theme-color-name">Dark Header</span>
                                            </li>
                                            <li data-theme="light" class="theme-color theme-color-light">
                                                <span class="theme-color-view"></span>
                                                <span class="theme-color-name">Light Header</span>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="col-md-8 col-sm-8 col-xs-12 seperator">
                                        <h3>LAYOUT</h3>
                                        <ul class="theme-settings">
                                            <li>
                                                 Theme Style
                                                <select class="layout-style-option form-control input-small input-sm">
                                                    <option selected="selected" value="square">Square corners</option>
                                                    <option value="rounded">Rounded corners</option>
                                                </select>
                                            </li>
                                            <li>
                                                 Layout
                                                <select class="layout-option form-control input-small input-sm">
                                                    <option selected="selected" value="fluid">Fluid</option>
                                                    <option value="boxed">Boxed</option>
                                                </select>
                                            </li>
                                            <li>
                                                 Header
                                                <select class="page-header-option form-control input-small input-sm">
                                                    <option selected="selected" value="fixed">Fixed</option>
                                                    <option value="default">Default</option>
                                                </select>
                                            </li>
                                            <li>
                                                 Top Dropdowns
                                                <select class="page-header-top-dropdown-style-option form-control input-small input-sm">
                                                    <option value="light">Light</option>
                                                    <option selected="selected" value="dark">Dark</option>
                                                </select>
                                            </li>
                                            <li>
                                                 Sidebar Mode
                                                <select class="sidebar-option form-control input-small input-sm">
                                                    <option value="fixed">Fixed</option>
                                                    <option selected="selected" value="default">Default</option>
                                                </select>
                                            </li>
                                            <li>
                                                 Sidebar Menu
                                                <select class="sidebar-menu-option form-control input-small input-sm">
                                                    <option selected="selected" value="accordion">Accordion</option>
                                                    <option value="hover">Hover</option>
                                                </select>
                                            </li>
                                            <li>
                                                 Sidebar Position
                                                <select class="sidebar-pos-option form-control input-small input-sm">
                                                    <option selected="selected" value="left">Left</option>
                                                    <option value="right">Right</option>
                                                </select>
                                            </li>
                                            <li>
                                                 Footer
                                                <select class="page-footer-option form-control input-small input-sm">
                                                    <option value="fixed">Fixed</option>
                                                    <option selected="selected" value="default">Default</option>
                                                </select>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                         END THEME PANEL
                    </div> -->
                    <!-- END PAGE TOOLBAR -->
                </div>
                <!-- END PAGE HEAD -->
                <!-- BEGIN PAGE BREADCRUMB -->
                <!-- <ul class="page-breadcrumb breadcrumb">
                    <li>
                        <a href="#">竞猜</a>
                        <i class="fa fa-circle"></i>
                    </li>
                </ul> -->
                <!-- END PAGE BREADCRUMB -->
                <!-- END PAGE HEADER-->
                <!-- BEGIN PAGE CONTENT-->
                <!-- 注释 查询开始  -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="portlet box">
                            <div class="portlet-body form">
                                <form role="form" class="form-horizontal">
                                    <div class="form-body">
                                        <div class="form-group">
                                            <label class="col-md-1 control-label">类型：</label>
                                            <div class="col-md-3">
                                                <label><input type="radio" name="qa-lucky-prize-type" class="form-control input-small" value="1"
                                                    <if condition="$qa_lucky_prize_type eq 1">checked</if>
                                                    >轮奖品</label>
                                                <label><input type="radio" name="qa-lucky-prize-type" class="form-control input-small" value="2"
                                                    <if condition="$qa_lucky_prize_type eq 2">checked</if>
                                                    >期奖品</label>
                                                <label><input type="radio" name="qa-lucky-prize-type" class="form-control input-small" value="3"
                                                    <if condition="$qa_lucky_prize_type eq 3">checked</if>
                                                    >总奖品</label>
                                            </div>
                                            <label class="col-md-2 control-label">奖品级别：</label>
                                            <div class="col-md-2">
                                                <select class="form-control input-inline input-small" name="select-lucky-prize-grade">
                                                    <option value="">选择奖品级别</option>
                                                    <foreach name="lucky_prize_grade" item="item" key="key">
                                                        <option value="{$item.grade_id}"
                                                        <if condition="$item.grade_id eq $find_grade_id">selected</if>
                                                        >{$item.grade_name}</option>
                                                    </foreach>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-md-2 control-label" style="width: 10% !important;">栏目选择：</label>
                                            <div class="col-md-2">
                                                <select class="form-control input-inline input-small select-qa-lucky-prize" name="select-column">
                                                    <option value="{$column.column_id}"
                                                    <if condition="$column.column_id eq $find_column_id">selected</if>
                                                    >{$column.column_name}</option>
                                                </select>
                                            </div>
                                            <label class="col-md-2 control-label" style="width: 10% !important;">期数选择：</label>
                                            <div class="col-md-2">
                                                <select class="form-control input-inline input-small select-qa-lucky-prize" name="select-stage">
                                                    <option value="">选择期数</option>
                                                    <foreach name="stage_list" item="item" key="key">
                                                        <option value="{$item.stage_id}"
                                                        <if condition="$item.stage_id eq $find_stage_id">selected</if>
                                                        >{$item.stage_name}</option>
                                                    </foreach>
                                                </select>
                                            </div>
                                            <label class="col-md-2 control-label" style="width: 10% !important;">分组选择：</label>
                                            <div class="col-md-2">
                                                <select class="form-control input-inline input-small select-qa-lucky-prize" name="select-group">
                                                    <option value="">选择分组</option>
                                                    <foreach name="group_list" item="item" key="key">
                                                        <option value="{$item.id}"
                                                        <if condition="$item.id eq $find_group_id">selected</if>
                                                        >{$item.group_title}</option>
                                                    </foreach>
                                                </select>
                                            </div>
                                            <div class="col-md-1">
                                                <button class="btn blue" type="button" id="qa-lucky-prize-import">导入</button>
                                            </div>
                                            <div class="col-md-1">
                                                <button class="btn blue" type="button" id="qa-lucky-prize-search">查看</button>
                                            </div>
                                        </div>
                                    </div>
                                </form>

                            </div>
                        </div>
                    </div>
                </div>
                <!-- 注释 查询结束  -->
                <div class="row">
                    <div class="col-md-12">
                        <!-- BEGIN EXAMPLE TABLE PORTLET-->
                        <div class="portlet box blue">
                            <div class="portlet-title">
                                <div class="caption">
                                    <i class="fa fa-edit"></i>奖品管理
                                </div>
                            </div>
                            <div class="portlet-body">
                                <button style="margin-bottom:5px;" class="btn blue qa-lucky-prize-delete" type="button" id="qa-lucky-prize-delete">批量删除</button>
                                <table class="table table-striped table-hover table-bordered" id="sample_editable_1">
                                    <thead>
                                    <tr>
                                        <th>序号</th>
                                        <th>奖品属于</th>
                                        <th>奖品等级</th>
                                        <th>奖品名称</th>
                                        <th>奖品编码</th>
                                        <th>奖品密码</th>
                                        <th>导入时间</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <notempty name="lucky_prize_list">
                                        <foreach name="lucky_prize_list" item="vo" key="key">
                                            <tr>
                                                <td>{$p * 15 - 15 + $key + 1}</td>
                                                <td>{$vo['lucky_prize_type'] == 1 ? '轮奖品' : $vo['lucky_prize_type'] == 2 ? '期奖品' : '总奖品'}</td>
                                                <td>{$vo.lucky_prize_grade}等奖</td>
                                                <td>{$vo.lucky_prize_title}</td>
                                                <td>{$vo.lucky_prize_number}</td>
                                                <td>{$vo.lucky_prize_key}</td>
                                                <td>{$vo.operate_time|date="Y-m-d H:i:s",###}</td>
                                            </tr>
                                        </foreach>
                                        <else/>
                                        <td colspan="11" class="text-center"> aOh! 暂时还没有内容!</td>
                                    </notempty>
                                    </tbody>
                                </table>
                                <div class="row">
                                    <div class="col-md-5 col-sm-12">
                                        <div class="dataTables_info" id="sample_editable_1_info" role="status"
                                             aria-live="polite">
                                            当前是第 {$p} 页 总页数 {$totalPage}
                                        </div>
                                    </div>
                                    <div class="col-md-7 col-sm-12">
                                        <div class="dataTables_paginate paging_simple_numbers"
                                             id="sample_editable_1_paginate">
                                            {$show}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- END EXAMPLE TABLE PORTLET-->
                    </div>
                </div>

                <!-- END PAGE CONTENT-->
            </div>
        </div>
    </div>
</div>
<script>
    $(function () {
        //初始化
        (function initPage() {
            var qa_lucky_prize_type = $("input[name='qa-lucky-prize-type']:checked").val();
            switch (parseInt(qa_lucky_prize_type)) {
                case 1:
                    $("#qa-lucky-prize-import").attr('disabled', false);
                    $(".select-qa-lucky-prize").attr('disabled', false);
                    break;
                case 2:
                    $("#qa-lucky-prize-import").attr('disabled', false);
                    $(".select-qa-lucky-prize").attr('disabled', true);
                    $("select[name='select-column']").attr('disabled', false);
                    $("select[name='select-stage']").attr('disabled', false);
                    $("select[name='select-group']").val('');
                    break;
                case 3:
                    $("#qa-lucky-prize-import").attr('disabled', false);
                    $(".select-qa-lucky-prize").attr('disabled', true);
                    $("select[name='select-column']").attr('disabled', false);
                    $("select[name='select-stage']").val('');
                    $("select[name='select-group']").val('');
                    break;
                default:
                    $(".select-qa-lucky-prize").attr('disabled', true);
                    $("#qa-lucky-prize-import").attr('disabled', true);
                    break;
            }
        })();

        //类型选择
        $("input[name='qa-lucky-prize-type']").on('change', function () {
            var qa_lucky_prize_type = $("input[name='qa-lucky-prize-type']:checked").val();
            switch (parseInt(qa_lucky_prize_type)) {
                case 1:
                    $("#qa-lucky-prize-import").attr('disabled', false);
                    $(".select-qa-lucky-prize").attr('disabled', false);
                    break;
                case 2:
                    $("#qa-lucky-prize-import").attr('disabled', false);
                    $(".select-qa-lucky-prize").attr('disabled', true);
                    $("select[name='select-column']").attr('disabled', false);
                    $("select[name='select-stage']").attr('disabled', false);
                    $("select[name='select-group']").val('');
                    break;
                case 3:
                    $("#qa-lucky-prize-import").attr('disabled', false);
                    $(".select-qa-lucky-prize").attr('disabled', true);
                    $("select[name='select-column']").attr('disabled', false);
                    $("select[name='select-stage']").val('');
                    $("select[name='select-group']").val('');
                    break;
                default:
                    $(".select-qa-lucky-prize").attr('disabled', true);
                    $("#qa-lucky-prize-import").attr('disabled', true);
                    break;
            }
        })
        //搜索
        $("#qa-lucky-prize-search").on('click', function () {
            var qa_lucky_prize_type = $("input[name='qa-lucky-prize-type']:checked").val();
            var find_grade_id = $("select[name='select-lucky-prize-grade']").val();
            var find_column_id = $("select[name='select-column']").val();
            var find_stage_id = $("select[name='select-stage']").val();
            var find_group_id = $("select[name='select-group']").val();
            if (qa_lucky_prize_type && (find_column_id || find_stage_id || find_group_id)) {
                var url = "{:U('QaLucky/luckyPrize')}" + "&qa_lucky_prize_type=" + qa_lucky_prize_type + "&find_grade_id=" + find_grade_id + "&find_column_id=" + find_column_id + "&find_stage_id=" + find_stage_id + "&find_group_id=" + find_group_id;
                window.location.href = url;
            }
        })
        //奖品导入
        $("#qa-lucky-prize-import").on('click', function () {
            var qa_lucky_prize_type = $("input[name='qa-lucky-prize-type']:checked").val();
            var find_grade_id = $("select[name='select-lucky-prize-grade']").val();
            var find_column_id = $("select[name='select-column']").val();
            var find_stage_id = $("select[name='select-stage']").val();
            var find_group_id = $("select[name='select-group']").val();
            switch (parseInt(qa_lucky_prize_type)) {
                case 1:
                    if (!find_column_id || !find_stage_id || !find_group_id || !find_grade_id) {
                        var title = '栏目，期数，分组，奖品级别必须选择';
                    } else {
                        var data = {
                            qa_lucky_prize_type: qa_lucky_prize_type,
                            find_grade_id: find_grade_id,
                            find_column_id: find_column_id,
                            find_stage_id: find_stage_id,
                            find_group_id: find_group_id,
                        }
                    }
                    break;
                case 2:
                    if (!find_column_id || !find_stage_id || !find_grade_id) {
                        var title = '栏目，期数，奖品级别必须选择';
                    } else {
                        var data = {
                            qa_lucky_prize_type: qa_lucky_prize_type,
                            find_grade_id: find_grade_id,
                            find_column_id: find_column_id,
                            find_stage_id: find_stage_id
                        }
                    }
                    break;
                case 3:
                    if (!find_column_id || !find_grade_id) {
                        var title = '栏目，奖品级别必须选择';
                    } else {
                        var data = {
                            qa_lucky_prize_type: qa_lucky_prize_type,
                            find_grade_id: find_grade_id,
                            find_column_id: find_column_id
                        }
                    }
                    break;
            }
            if (!data && title) {
                $.confirm({
                    title: title,
                    level: 'warning',
                    buttons: {
                        "确定": {
                            class: "blue"
                        }
                    }
                })
                return false;
            }
            var options = {
                title: '上传奖品清单文件',
                width: 800,
                border: 0,
                top: '25%',
                submit: function () {
                    $("#prize-list-form").ajaxSubmit({
                        url: "{:U('QaLucky/importPrize')}",
                        type: 'POST',
                        data: data,
                        dataType: 'JSON',
                        beforeSend: function () {
                            $("#qa-lucky-prize-import").attr({disabled: "disabled"});
                            $.refreshWindow.open("正在导入,请稍后...");
                        },
                        uploadProgress: function (event, position, total, percentComplete) {

                        },
                        complete: function () {
                            $("#qa-lucky-prize-import").attr({disabled: false});
                            $.refreshWindow.close();
                        },
                        success: function (res) {
                            console.log(res);
                            if (res.status == 1) {
                                var url = "{:U('QaLucky/luckyPrize')}" + "&qa_lucky_prize_type=" + qa_lucky_prize_type + "&find_grade_id=" + find_grade_id + "&find_column_id=" + find_column_id + "&find_stage_id=" + find_stage_id + "&find_group_id=" + find_group_id;
                                window.location.href = url;
                            } else {
                                $.confirm({
                                    title: res.msg,
                                    level: 'warning',
                                    buttons: {
                                        "确定": {
                                            class: "blue"
                                        }
                                    }
                                })
                            }
                        },
                        error: function (e) {
                            alert(e.statusText);
                        }
                    });
                }
            }
            var html = '<form id="prize-list-form" method="post" enctype="multipart/form-data">';
            html += '<div style="margin: 10px;">';
            html += '<span style="font-size: 15px;">奖品清单文件 *：</span>';
            html += '<input type="file" style="display: inline-block;" name="prize_list" class="form-control input-inline input-medium">';
            html += '</div>';
            html += '</form>';
            $.jBox(html, options);
        })

        //奖品删除
        $("#qa-lucky-prize-delete").on('click', function () {
            var qa_lucky_prize_type = $("input[name='qa-lucky-prize-type']:checked").val();
            var find_grade_id = $("select[name='select-lucky-prize-grade']").val();
            var find_column_id = $("select[name='select-column']").val();
            var find_stage_id = $("select[name='select-stage']").val();
            var find_group_id = $("select[name='select-group']").val();
            if (qa_lucky_prize_type == 1 && find_column_id && find_stage_id && find_group_id) {
                var title = '您确认删除' + $("select[name='select-column']").find("option:selected").text() + $("select[name='select-stage']").find("option:selected").text() + $("select[name='select-group']").find("option:selected").text();
            } else if (qa_lucky_prize_type == 2 && find_column_id && find_stage_id) {
                var title = '您确认删除' + $("select[name='select-column']").find("option:selected").text() + $("select[name='select-stage']").find("option:selected").text();
            } else if (qa_lucky_prize_type == 3 && find_column_id) {
                var title = '您确认删除' + $("select[name='select-column']").find("option:selected").text();
            } else {
                $.confirm({
                    title: '请先选择需要删除的列表', modal: true, level: "danger", buttons: {
                        "确定": {
                            "class": "green", "action": function () {
                            }
                        }
                    }
                });
            }
            if (find_grade_id) {
                title += $("select[name='select-lucky-prize-grade']").find("option:selected").text() + '奖品吗？';
            } else {
                title += '奖品吗？';
            }
            $.confirm({
                title: title,
                modal: true,
                level: "warning",
                buttons: {
                    "确定": {
                        "class": "green",
                        "action": function () {
                            $.ajax({
                                url: "{:U('QaLucky/deleteLuckyPrize')}",
                                type: 'post',
                                data: {qa_lucky_prize_type:qa_lucky_prize_type,find_grade_id:find_grade_id,find_column_id:find_column_id,find_stage_id:find_stage_id,find_group_id:find_group_id},
                                dataType: 'json',
                                success: function (res) {
                                    if (res.status == 1) {
                                        location.href = document.referrer;
                                    } else {
                                        $.confirm({
                                            title: '删除失败！', modal: true, level: "danger", buttons: {
                                                "确定": {
                                                    "class": "green", "action": function () {
                                                    }
                                                }
                                            }
                                        });
                                    }
                                }
                            });
                        }
                    },
                    "取消": {
                        "class": "green", "action": function () {
                        }
                    }
                }
            });
        })
    })
</script>

<include file="Public/footer"/>